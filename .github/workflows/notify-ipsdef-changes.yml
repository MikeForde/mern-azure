name: Notify IPS Definition Changes

on:
  push:
    branches:
      - main
    paths:
      - 'client/publix/ipsdef/**'
  
  workflow_dispatch:

jobs:
  notify:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need previous commit to compare
      
      - name: Get changed files
        id: changed-files
        run: |
          # Get list of changed files in the target directory
          CHANGED_FILES=$(git diff --name-only HEAD^ HEAD -- client/publix/ipsdef/)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGED_FILES" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Count number of changed files
          FILE_COUNT=$(echo "$CHANGED_FILES" | grep -c '^' || echo "0")
          echo "count=$FILE_COUNT" >> $GITHUB_OUTPUT
      
      - name: Send email notification
        if: steps.changed-files.outputs.count > 0 || github.event_name == 'workflow_dispatch'
        uses: actions/github-script@v7
        env:
          GMAIL_ADDRESS: ${{ secrets.GMAIL_ADDRESS }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          NOTIFICATION_EMAILS: ${{ vars.NOTIFICATION_EMAILS }}
          CHANGED_FILES: ${{ steps.changed-files.outputs.files }}
        with:
          script: |
            const nodemailer = require('nodemailer');
            
            // Parse comma-separated email list
            const emailList = process.env.NOTIFICATION_EMAILS
              .split(',')
              .map(email => email.trim())
              .filter(email => email.length > 0)
              .join(',');
            
            if (!emailList) {
              throw new Error('No valid email addresses found in NOTIFICATION_EMAILS variable');
            }
            
            const changedFiles = process.env.CHANGED_FILES.trim().split('\n').filter(f => f);
            const fileList = changedFiles.length > 0 
              ? changedFiles.map(f => `  â€¢ ${f}`).join('\n')
              : '  (No files changed - manual test trigger)';
            
            // Create transporter
            const transporter = nodemailer.createTransport({
              host: 'smtp.gmail.com',
              port: 587,
              secure: false, // true for 465, false for other ports
              auth: {
                user: process.env.GMAIL_ADDRESS,
                pass: process.env.GMAIL_APP_PASSWORD
              }
            });
            
            // Email content
            const mailOptions = {
              from: `"IPS Website Notifier" <${process.env.GMAIL_ADDRESS}>`,
              to: emailList,
              subject: 'IPS MERN Website has been updated',
              text: `IPS MERN Website has been updated

              The following files in client/publix/ipsdef/ have been modified:

              ${fileList}

              Commit: ${context.sha.substring(0, 7)}

              View Changes: https://ipsmern-dep.azurewebsites.net/schemaviewer
              `
            };
            
            // Send email
            console.log(`Sending to: ${emailList}`);
            const info = await transporter.sendMail(mailOptions);
            console.log('Email sent successfully!');
            console.log('Message ID:', info.messageId);